<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ImmoChezSoi ‚Äî Immobilier d'exception</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="theme-junot.css">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tG2G2zFE8D1J9x4x0h38=" crossorigin=""/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

  <style>
    .results-info{max-width:1200px;margin:10px auto 0;padding:0 20px;color:var(--muted)}
    .empty-state{color:var(--muted);text-align:center;padding:24px}
    .media.is-empty{background:#f3f3f3;display:grid;place-items:center;color:#999;padding-top:62%}

    .site-header{position:sticky;top:0;z-index:1000;background:#fff}
    .menu-btn{font-size:22px;background:none;border:0;cursor:pointer}

    @media (min-width: 901px){
      .menu-btn{display:none}
      .nav-links{display:flex;gap:18px;align-items:center}
    }
    @media (max-width: 900px){
      .nav-links{
        position:absolute;left:12px;right:12px;top:64px;
        display:none;flex-direction:column;gap:12px;
        background:#fff;border:1px solid #eee;border-radius:12px;
        padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.08)
      }
      .nav-links.is-open{display:flex}
    }
  </style>
</head>
<body>

  <header class="site-header">
    <button class="menu-btn" aria-label="Ouvrir le menu" aria-expanded="false" aria-controls="primary-nav">‚ò∞</button>
    <a class="brand" href="index.html">ImmoChezSoi</a>
    <nav class="nav-links" id="primary-nav">
      <a href="#" data-nav="acheter">Acheter</a>
      <a href="#" data-nav="louer">Louer</a>
      <a href="contact.html">Contact</a>
      <a href="connexion.html">Connexion</a>
    </nav>
  </header>

  <section class="hero" role="banner" aria-label="Immobilier d'exception">
    <div class="hero-media" style="background-image:url('https://images.unsplash.com/photo-1554995207-c18c203602cb?q=80&w=2070&auto=format&fit=crop');"></div>

    <div class="hero-search">
      <div class="search-tabs" role="tablist">
        <button class="tab active" data-mode="acheter" role="tab" aria-selected="true">ACHETER</button>
        <button class="tab" data-mode="louer" role="tab" aria-selected="false">LOUER</button>
        <button class="tab" data-mode="vendre" role="tab" aria-selected="false">VENDRE</button>
      </div>

      <form class="search-bar" id="search-form" onsubmit="return false;">
        <div class="field">
          <label class="select">
            <select id="deal-filter" aria-label="Type d'op√©ration">
              <option value="">Acheter ou louer</option>
              <option value="acheter" selected>Acheter</option>
              <option value="louer">Louer</option>
            </select>
          </label>
        </div>

        <div class="field icon-left">
          <span class="icon">üìç</span>
          <input
            type="text"
            id="address-input"
            placeholder="O√π ?"
            aria-label="Adresse ou quartier"
            list="places-suggest"
            autocomplete="off"
            inputmode="text">
          <datalist id="places-suggest"></datalist>
        </div>

        <div class="field">
          <label class="select">
            <select id="rooms-filter" aria-label="Nombre de pi√®ces">
              <option value="">Pi√®ces</option>
              <option value="2">2+</option>
              <option value="3">3+</option>
              <option value="4">4+</option>
              <option value="5">5+</option>
            </select>
          </label>
        </div>

        <div class="field">
          <label class="select">
            <select id="type-filter" aria-label="Type de bien">
              <option value="">Type de biens</option>
              <option value="Appartement">Appartement</option>
              <option value="Villa">Villa</option>
              <option value="Bureau">Bureau</option>
              <option value="Terrain nu">Terrain</option>
            </select>
          </label>
        </div>

        <button id="btn-search" class="cta" type="submit" aria-label="Lancer la recherche">Rechercher</button>
        <input type="hidden" id="mode" value="acheter">
      </form>
    </div>
  </section>

  <main>
    <section class="intro">
      <h1>R√©v√©ler l'immobilier d'exception</h1>
      <p>D√©couvrez une s√©lection confidentielle de biens √† Abidjan. Expertise, √©l√©gance et service sur-mesure.</p>
    </section>

    <section class="maison-intro" aria-label="Notre maison √† Abidjan">
      <div class="maison-inner">
        <p>
          Maison ivoirienne d√©di√©e aux biens de caract√®re, ImmoChezSoi accompagne ses clients √† Abidjan
          et dans toute la C√¥te d‚ÄôIvoire, avec une connaissance fine des quartiers ‚Äî Cocody, Plateau,
          Zone 4, Marcory, Riviera, Bingerville‚Ä¶ Chaque projet b√©n√©ficie d‚Äôun suivi sur-mesure
          alliant exigence, discr√©tion et sens du d√©tail.
        </p>
        <p>
          Que vous souhaitiez vendre, louer ou investir, nous valorisons votre patrimoine avec des
          outils modernes, des visuels soign√©s et un r√©seau de confiance ‚Äî en local comme au sein de
          la diaspora. Notre ambition : transformer chaque adresse en une exp√©rience unique,
          simple et sereine.
        </p>
        <div class="maison-divider" role="presentation"></div>
        <a class="maison-cta" href="contact.html">D√©couvrir la maison ImmoChezSoi</a>
      </div>
    </section>

    <section class="listing" aria-label="Nos biens d'exception">
      <h2>Nos biens d'exception</h2>
      <div id="results-info" class="results-info"></div>
      <div id="cards" class="cards"></div>
    </section>
  </main>

  <footer class="site-footer">
    <p>¬© 2025 ImmoChezSoi ‚Äî Abidjan | <a href="contact.html">Contact</a></p>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script src="script-leaflet.js"></script>

  <script>
    function norm(s){ return (s||'').toString().toLowerCase().trim(); }
    function getAllProperties(){
      try { return JSON.parse(localStorage.getItem('properties') || '[]'); } catch(e){ return []; }
    }

    (function ensureDeal(){
      let arr=[]; try{ arr = JSON.parse(localStorage.getItem('properties')||'[]'); }catch(e){}
      let changed=false;
      arr.forEach(p=>{ if(!p.deal){ p.deal='acheter'; changed=true; }});
      if (changed) localStorage.setItem('properties', JSON.stringify(arr));
    })();

    function renderCards(list){
      const wrap = document.getElementById('cards');
      const info = document.getElementById('results-info');
      wrap.innerHTML = '';
      info.textContent = list.length ? `${list.length} r√©sultat(s)` : '';
      if (!list.length){
        wrap.innerHTML = '<div class="empty-state">Aucun bien ne correspond √† vos crit√®res.</div>';
        return;
      }
      list.slice(0, 30).forEach(p=>{
        const price = new Intl.NumberFormat('fr-FR').format(+p.price || 0) + ' FCFA';
        const rooms = p.rooms ? (p.rooms + ' pi√®ces ‚Ä¢ ') : '';
        const type  = p.type || 'Bien';
        const img   = p.photoUrl || '';
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <div class="media${img?'':' is-empty'}" style="${img?`background-image:url('${img}')`:''}"></div>
          <div class="body">
            <span class="badge">${type}</span>
            <h3>${p.title || 'Bien immobilier'}</h3>
            <p class="muted">${rooms}${p.address || ''}</p>
            <div class="meta">
              <strong>${price}</strong>
              <button class="btn-outline" data-address="${p.address||''}">Voir l‚Äôadresse</button>
            </div>
          </div>`;
        wrap.appendChild(card);
      });
      wrap.onclick = (e)=>{
        const btn = e.target.closest('.btn-outline');
        if (!btn) return;
        const q = btn.getAttribute('data-address') || '';
        if (!q) return;
        window.open('https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(q), '_blank');
      };
    }

    function applyFilters(){
      const all = getAllProperties();
      const modeSel = (document.getElementById('deal-filter')?.value || '').trim();
      const mode    = (modeSel || document.getElementById('mode')?.value || '').trim();
      const priceMax = document.getElementById('price-filter')?.value || '';
      const type     = document.getElementById('type-filter')?.value || '';
      const roomsMin = document.getElementById('rooms-filter')?.value || '';
      const q        = norm(document.getElementById('address-input')?.value || '');

      const filtered = all.filter(p=>{
        const okMode = !mode || !p.deal || p.deal === mode;
        const okPrice = !priceMax || (+p.price <= +priceMax);
        const okType  = !type || (p.type === type);
        const okRooms = !roomsMin || (+p.rooms || 0) >= (+roomsMin);
        const hay     = norm([p.address, p.title, p.type].filter(Boolean).join(' '));
        const okQ     = !q || hay.includes(q);
        return okMode && okPrice && okType && okRooms && okQ;
      }).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

      renderCards(filtered);
    }

    document.addEventListener('click', (e) => {
      const t = e.target.closest('.tab');
      if (!t) return;
      document.querySelectorAll('.tab').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected','false') });
      t.classList.add('active'); t.setAttribute('aria-selected','true');
      const newMode = t.dataset.mode;
      document.getElementById('mode').value = newMode;
      const dealSel = document.getElementById('deal-filter');
      if (dealSel){
        dealSel.value = (newMode === 'acheter' || newMode === 'louer') ? newMode : '';
      }
      applyFilters();
      if (window.searchAndRender) window.searchAndRender();
      document.querySelector('.listing')?.scrollIntoView({behavior:'smooth', block:'start'});
    });

    document.querySelectorAll('.nav-links a[data-nav]').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        const target = a.getAttribute('data-nav');
        const tab = document.querySelector(`.tab[data-mode="${target}"]`);
        if (tab) tab.click();
      });
    });

    document.addEventListener('error', function(e){
      if (e.target && e.target.tagName === 'IMG') e.target.remove();
    }, true);

    document.addEventListener('DOMContentLoaded', ()=>{
      const dealSel = document.getElementById('deal-filter');
      if (dealSel){
        document.getElementById('mode').value = dealSel.value || 'acheter';
        const tab = document.querySelector(`.tab[data-mode="${dealSel.value||'acheter'}"]`);
        if (tab){ tab.classList.add('active'); tab.setAttribute('aria-selected','true'); }
      }

      applyFilters();

      const form = document.getElementById('search-form');
      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        applyFilters();
        if (window.searchAndRender) window.searchAndRender();
      });

      const btn = document.getElementById('btn-search');
      if (btn) btn.addEventListener('click', (e)=>{
        e.preventDefault();
        applyFilters();
        if (window.searchAndRender) window.searchAndRender();
      });

      document.getElementById('address-input')?.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter'){ e.preventDefault(); applyFilters(); if (window.searchAndRender) window.searchAndRender(); }
      });

      dealSel?.addEventListener('change', ()=>{
        const val = dealSel.value;
        document.getElementById('mode').value = val || 'acheter';
        document.querySelectorAll('.tab').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected','false') });
        const t = document.querySelector(`.tab[data-mode="${val||'acheter'}"]`);
        if (t){ t.classList.add('active'); t.setAttribute('aria-selected','true'); }
        applyFilters();
        if (window.searchAndRender) window.searchAndRender();
      });

      if (new URLSearchParams(location.search).has('bye')) {
        alert('Vous avez √©t√© d√©connect√© ‚úÖ');
      }
    });

    (function(){
      const btn = document.querySelector('.menu-btn');
      const nav = document.getElementById('primary-nav');
      if (!btn || !nav) return;
      function setOpen(open){
        nav.classList.toggle('is-open', open);
        btn.setAttribute('aria-expanded', String(open));
      }
      btn.addEventListener('click', () => {
        const open = nav.classList.contains('is-open');
        setOpen(!open);
      });
      nav.addEventListener('click', (e) => { if (e.target.tagName === 'A') setOpen(false); });
      window.addEventListener('resize', () => { if (window.innerWidth > 900) setOpen(false); });
      document.addEventListener('click', (e) => {
        if (!nav.contains(e.target) && e.target !== btn) setOpen(false);
      });
    })();
  </script>

  <!-- Suggestions d‚Äôadresses √† partir des biens enregistr√©s (s√©curis√©) -->
  <script>
    (function(){
      var KEY = 'properties';
      var input = document.getElementById('address-input');
      var dl = document.getElementById('places-suggest');
      if (!input || !dl) return;

      function readProps(){
        try { return JSON.parse(localStorage.getItem(KEY) || '[]'); }
        catch(e){ return []; }
      }
      function unique(arr){
        var s = new Set();
        arr.forEach(function(v){ if(v && v.trim()) s.add(v.trim()); });
        return Array.from(s);
      }
      function buildPool(){
        var props = readProps();
        var pool = [];
        props.forEach(function(p){
          if (p.address) pool.push(p.address);
          if (p.title)   pool.push(p.title);
          if (p.address && p.address.includes(',')) {
            p.address.split(',').forEach(function(part){ pool.push(part); });
          }
        });
        return unique(pool);
      }

      var all = buildPool();
      function refreshOptions(q){
        var qn = (q||'').toLowerCase();
        var list = all.filter(function(v){ return v.toLowerCase().includes(qn); }).slice(0, 12);
        dl.innerHTML = '';
        list.forEach(function(v){
          var opt = document.createElement('option');
          opt.value = v;
          dl.appendChild(opt);
        });
      }

      refreshOptions('');
      input.addEventListener('input', function(){ refreshOptions(input.value); });
      window.addEventListener('storage', function(e){
        if (e.key === KEY) { all = buildPool(); refreshOptions(input.value); }
      });
    })();
  </script>
</body>
</html>
